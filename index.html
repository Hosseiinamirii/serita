<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-Content-Type-Options" content="nosniff">
    <title>سوالات استراتژیک کلینیک سریتا - قابل ویرایش</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: Arial, sans-serif; background-color: #f7fafc; color: #2d3748; }
        .card { background-color: white; border-radius: 8px; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); padding: 1rem; transition: all 0.3s; }
        .card:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); }
        textarea { resize: vertical; min-height: 50px; transition: all 0.2s; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; transition: opacity 0.3s; }
        .modal-content { background: white; margin: 10% auto; padding: 20px; width: 90%; max-width: 500px; border-radius: 8px; position: relative; top: 50%; transform: translateY(-50%); transition: all 0.3s; }
        .draggable:hover { cursor: move; }
        .toast { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: #2d3748; color: white; padding: 10px 20px; border-radius: 4px; display: none; z-index: 1001; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .section-draggable { transition: all 0.2s; }
        .section-draggable.dragging { opacity: 0.5; }
        .collapsible-content { display: none; opacity: 0; transition: opacity 0.3s ease-out; }
        .collapsible-content.open { display: block; opacity: 1; }
        .auto-save-status { font-size: 0.8rem; color: #718096; text-align: center; margin-top: 10px; }
        .action-buttons button { transition: transform 0.2s; }
        .action-buttons button:hover { transform: scale(1.1); }
        .question-card { margin-bottom: 1rem; padding: 1rem; background-color: #edf2f7; border-left: 4px solid #4299e1; }
        .question-card textarea { width: 100%; margin-top: 0.5rem; }
        @media (max-width: 768px) {
            .modal-content { width: 95%; margin: 20% auto; }
            .action-buttons { position: relative; }
            .action-buttons button:not(:first-child) { display: none; }
            .action-buttons:hover button { display: inline-block; position: absolute; top: 0; right: 0; background: white; border: 1px solid #e2e8f0; }
            .action-buttons button:nth-child(2) { top: 30px; }
            .action-buttons button:nth-child(3) { top: 60px; }
            .action-buttons button:nth-child(4) { top: 90px; }
            .action-buttons button:nth-child(5) { top: 120px; }
        }
        @media print {
            .action-buttons, select, button:not([type="submit"]), input[type="checkbox"] { display: none; }
            textarea { border: none; resize: none; height: auto; }
        }
        .icon { width: 16px; height: 16px; vertical-align: middle; }
    </style>
</head>
<body>
    <div class="container mx-auto p-4 md:p-8">
        <h1 class="text-2xl md:text-3xl font-bold text-center text-gray-800 mb-6">سوالات استراتژیک کلینیک سریتا</h1>
        <p class="text-center text-sm md:text-base mb-4 text-gray-600">هدف: شناخت عمیق برای ارزیابی پتانسیل گسترش</p>

        <!-- فیلترها و جستجو -->
        <div class="card p-4 mb-6">
            <div class="flex flex-col md:flex-row gap-4">
                <div class="flex-1">
                    <label for="priorityFilter" class="block text-sm font-medium text-gray-700">فیلتر اولویت:</label>
                    <select id="priorityFilter" onchange="filterQuestions()" class="w-full p-2 border rounded">
                        <option value="all">همه</option>
                        <option value="high">بالا</option>
                        <option value="medium">متوسط</option>
                    </select>
                </div>
                <div class="flex-1">
                    <label for="categoryFilter" class="block text-sm font-medium text-gray-700">فیلتر دسته‌بندی:</label>
                    <select id="categoryFilter" onchange="filterQuestions()" class="w-full p-2 border rounded">
                        <option value="all">همه</option>
                    </select>
                </div>
                <div class="flex-1">
                    <label for="searchInput" class="block text-sm font-medium text-gray-700">جستجو:</label>
                    <div class="flex">
                        <input id="searchInput" type="text" class="w-full p-2 border rounded-l" placeholder="جستجوی متن...">
                        <button onclick="searchQuestions()" class="bg-blue-600 text-white px-4 py-2 rounded-r hover:bg-blue-700">جستجو</button>
                    </div>
                </div>
            </div>
            <div class="flex gap-2 mt-4">
                <button onclick="saveResponses()" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">ذخیره پاسخ‌ها</button>
                <button onclick="exportToCSV()" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">دانلود CSV</button>
                <button onclick="addSection()" class="bg-purple-600 text-white px-4 py-2 rounded hover:bg-purple-700">افزودن بخش جدید</button>
            </div>
        </div>
        <div id="autoSaveStatus" class="auto-save-status">آخرین ذخیره خودکار: هنوز ذخیره نشده</div>

        <!-- محتوای اصلی -->
        <div id="sections" class="space-y-8"></div>

        <!-- پاپ‌آپ پیش‌نمایش -->
        <div id="previewModal" class="modal">
            <div class="modal-content">
                <h3 class="text-lg font-semibold mb-2 text-gray-800">پیش‌نمایش پاسخ‌ها</h3>
                <textarea id="previewText" class="w-full p-2 border rounded text-sm" rows="6" readonly></textarea>
                <div class="flex gap-2 mt-4">
                    <button onclick="editPreview()" class="bg-yellow-600 text-white px-4 py-2 rounded hover:bg-yellow-700">ویرایش</button>
                    <button onclick="closePreviewModal()" class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600">بستن</button>
                </div>
            </div>
        </div>

        <!-- پاپ‌آپ یادداشت -->
        <div id="noteModal" class="modal">
            <div class="modal-content">
                <h3 class="text-lg font-semibold mb-2 text-gray-800">یادداشت پیشنهادی</h3>
                <textarea id="modalText" class="w-full p-2 border rounded text-sm" rows="6"></textarea>
                <div class="flex gap-2 mt-4">
                    <button onclick="saveNote()" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">ذخیره</button>
                    <button onclick="closeNoteModal()" class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600">بستن</button>
                </div>
            </div>
        </div>

        <!-- اعلان -->
        <div id="toast" class="toast"></div>
    </div>

    <script>
        let sectionsData = [
            {
                title: "1.1 زیرساخت و عملیات",
                category: "infrastructure",
                questions: [
                    { text: "زیرساخت فعلی سریتا (تجهیزات، فضا) چه ظرفیت‌هایی برای افزایش حجم بیماران دارد؟", priority: "high", note: "" },
                    { text: "فرآیندهای عملیاتی (مثل نوبت‌دهی، درمان) چگونه می‌توانند برای حجم بالاتر بهینه شوند؟", priority: "high", note: "" },
                    { text: "چه گلوگاه‌هایی در عملیات روزانه مانع افزایش ظرفیت خدمات هستند؟", priority: "high", note: "" }
                ]
            },
            {
                title: "1.2 بازاریابی",
                category: "marketing",
                questions: [
                    { text: "استراتژی بازاریابی فعلی سریتا چگونه بیماران جدید را در بازار محلی جذب می‌کند؟", priority: "high", note: "" },
                    { text: "چه کانال‌های بازاریابی (دیجیتال یا آفلاین) بیشترین تأثیر را در جذب بیماران داشته‌اند؟", priority: "high", note: "" },
                    { text: "چگونه بازخورد بیماران فعلی برای بهبود استراتژی‌های بازاریابی استفاده می‌شود؟", priority: "high", note: "" }
                ]
            }
        ];

        let currentNoteIndex = null;
        let currentPreviewRow = null;
        let autoSaveTimeout = null;

        function renderSections() {
            const sectionsContainer = document.getElementById('sections');
            sectionsContainer.innerHTML = '';
            const categoryFilter = document.getElementById('categoryFilter');
            categoryFilter.innerHTML = '<option value="all">همه</option>';

            sectionsData.forEach((section, sectionIndex) => {
                const sectionElement = document.createElement('section');
                sectionElement.setAttribute('data-category', section.category);
                sectionElement.className = 'fade-in section-draggable';
                sectionElement.draggable = true;
                sectionElement.dataset.index = sectionIndex;
                sectionElement.innerHTML = `
                    <div class="card flex items-center gap-2 mb-4">
                        <button onclick="toggleCollapse(this, ${sectionIndex})" class="text-gray-600 text-sm mr-2">⬇️</button>
                        <h2 class="text-xl md:text-2xl font-bold text-gray-800 flex-1">${section.title}</h2>
                        <button onclick="editSectionTitle(this, ${sectionIndex})" class="text-blue-600 text-sm flex items-center">
                            <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                                <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                            </svg> ویرایش
                        </button>
                        <button onclick="deleteSection(this, ${sectionIndex})" class="text-red-600 text-sm flex items-center">
                            <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M3 6h18M10 6V4a2 2 0 0 1 2-2h0a2 2 0 0 1 2 2v2M10 11v6M14 11v6M4 6h16l-1 12a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2l-1-12z"></path>
                            </svg> حذف
                        </button>
                    </div>
                    <div class="collapsible-content" data-section="${sectionIndex}">
                        <ul class="space-y-4 question-list" data-category="${section.category}"></ul>
                        <div class="card mt-4">
                            <h4 class="text-base font-semibold mb-2 text-gray-700">افزودن سوال جدید</h4>
                            <input type="text" class="w-full p-2 border rounded mb-2" placeholder="سوال جدید...">
                            <select class="border rounded text-xs p-2 mb-2">
                                <option value="high">بالا</option>
                                <option value="medium">متوسط</option>
                            </select>
                            <button onclick="addQuestion(this, ${sectionIndex})" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">افزودن</button>
                        </div>
                        <div class="card mt-4">
                            <h4 class="text-base font-semibold mb-2 text-gray-700">یادداشت بخش</h4>
                            <textarea class="w-full p-2 border rounded text-sm section-note" placeholder="یادداشت‌های بخش را اینجا بنویسید..." data-section="${sectionIndex}"></textarea>
                        </div>
                        <div class="mt-4 space-y-4">
                            ${section.questions.map((q, qIndex) => `
                                <div class="question-card" data-index="${qIndex}">
                                    <div class="flex items-start gap-2">
                                        <label class="flex-1 text-sm md:text-base text-gray-700">${q.text}</label>
                                        <div class="action-buttons flex gap-2">
                                            <button onclick="previewQuestion(this, ${sectionIndex}, ${qIndex})" class="bg-green-600 text-white px-2 py-1 rounded hover:bg-green-700 text-xs flex items-center">
                                                <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                    <path d="M15 12a3 3 0 1 1-6 0 3 3 0 0 1 6 0z"></path>
                                                    <path d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                                                </svg>
                                            </button>
                                        </div>
                                    </div>
                                    <textarea class="mt-2" placeholder="پاسخ کوتاه..."></textarea>
                                    <textarea class="mt-2" placeholder="نکات کلیدی..."></textarea>
                                    <textarea class="mt-2" placeholder="اقدام پیشنهادی..."></textarea>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
                sectionsContainer.appendChild(sectionElement);

                const ul = sectionElement.querySelector('ul');
                section.questions.forEach((q, qIndex) => {
                    const li = document.createElement('li');
                    li.className = 'card draggable fade-in';
                    li.draggable = true;
                    li.dataset.index = qIndex;
                    li.innerHTML = `
                        <div class="flex items-start gap-2">
                            <input type="checkbox" class="mt-1">
                            <label class="flex-1 text-sm md:text-base text-gray-700">${q.text}</label>
                            <select class="priority border rounded text-xs p-1" onchange="updatePriority(this, ${sectionIndex}, ${qIndex})">
                                <option value="high" ${q.priority === 'high' ? 'selected' : ''}>بالا</option>
                                <option value="medium" ${q.priority === 'medium' ? 'selected' : ''}>متوسط</option>
                            </select>
                            <div class="action-buttons flex gap-2">
                                <button onclick="editQuestion(this, ${sectionIndex}, ${qIndex})" class="text-blue-600 text-xs flex items-center">
                                    <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                                        <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                                    </svg>
                                </button>
                                <button onclick="deleteQuestion(this, ${sectionIndex}, ${qIndex})" class="text-red-600 text-xs flex items-center">
                                    <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M3 6h18M10 6V4a2 2 0 0 1 2-2h0a2 2 0 0 1 2 2v2M10 11v6M14 11v6M4 6h16l-1 12a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2l-1-12z"></path>
                                    </svg>
                                </button>
                                <button onclick="moveQuestion(this, 'up', ${sectionIndex}, ${qIndex})" class="text-green-600 text-xs flex items-center">
                                    <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M5 10l7-7m0 0l7 7m-7-7v18"></path>
                                    </svg>
                                </button>
                                <button onclick="moveQuestion(this, 'down', ${sectionIndex}, ${qIndex})" class="text-green-600 text-xs flex items-center">
                                    <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M19 14l-7 7m0 0l-7-7m7 7V3"></path>
                                    </svg>
                                </button>
                                <button onclick="openNoteModal('${q.note}', ${sectionIndex}, ${qIndex})" class="text-purple-600 text-xs flex items-center">
                                    <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path>
                                        <path d="M17 21v-8H7v8M7 3v5h8"></path>
                                    </svg>
                                </button>
                            </div>
                        </div>
                    `;
                    ul.appendChild(li);
                });

                categoryFilter.innerHTML += `<option value="${section.category}">${section.title}</option>`;
            });

            setupDragAndDrop();
            setupSectionDragAndDrop();
            loadResponses();
        }

        function toggleCollapse(btn, sectionIndex) {
            const section = btn.closest('section');
            if (!section) return;

            const content = section.querySelector('.collapsible-content');
            if (!content) return;

            const isOpen = content.classList.contains('open');
            section.classList.toggle('collapsed', !isOpen);
            content.classList.toggle('open', !isOpen);
            btn.textContent = isOpen ? '⬇️' : '⬆️';

            setTimeout(() => {
                if (content.classList.contains('open')) {
                    content.style.display = 'block';
                    content.style.opacity = '1';
                } else {
                    content.style.opacity = '0';
                    setTimeout(() => {
                        content.style.display = 'none';
                    }, 300);
                }
            }, 10);
        }

        function updateQuestionDropdown(sectionIndex = null) {
            const select = document.getElementById('questionSelect');
            select.innerHTML = '<option value="">سوال را انتخاب کنید</option>';
            if (sectionIndex !== null) {
                sectionsData[sectionIndex].questions.forEach((q, qIndex) => {
                    const option = document.createElement('option');
                    option.value = qIndex;
                    option.text = q.text;
                    select.appendChild(option);
                });
            }
        }

        function addSection() {
            const title = prompt('عنوان بخش جدید را وارد کنید:');
            if (!title) return showToast('عنوان بخش نمی‌تواند خالی باشد!');
            const category = 'category_' + Date.now();
            sectionsData.push({ title, category, questions: [] });
            renderSections();
            saveData();
            showToast('بخش جدید اضافه شد!');
        }

        function editSectionTitle(btn, sectionIndex) {
            const h2 = btn.parentElement.querySelector('h2');
            const newTitle = prompt('عنوان جدید:', h2.textContent);
            if (newTitle) {
                sectionsData[sectionIndex].title = newTitle;
                renderSections();
                saveData();
                showToast('عنوان بخش ویرایش شد!');
            }
        }

        function deleteSection(btn, sectionIndex) {
            if (confirm('آیا از حذف این بخش مطمئن هستید؟')) {
                sectionsData.splice(sectionIndex, 1);
                renderSections();
                saveData();
                showToast('بخش حذف شد!');
            }
        }

        function addQuestion(btn, sectionIndex) {
            const input = btn.parentElement.querySelector('input');
            const select = btn.parentElement.querySelector('select');
            const text = input.value.trim();
            if (!text) return showToast('سوال نمی‌تواند خالی باشد!');
            sectionsData[sectionIndex].questions.push({
                text,
                priority: select.value,
                note: ''
            });
            input.value = '';
            renderSections();
            saveData();
            showToast('سوال جدید اضافه شد!');
        }

        function editQuestion(btn, sectionIndex, qIndex) {
            const li = btn.closest('li');
            const label = li.querySelector('label');
            const newText = prompt('سوال جدید:', label.textContent);
            if (newText) {
                sectionsData[sectionIndex].questions[qIndex].text = newText;
                renderSections();
                saveData();
                showToast('سوال ویرایش شد!');
            }
        }

        function deleteQuestion(btn, sectionIndex, qIndex) {
            if (confirm('آیا از حذف این سوال مطمئن هستید؟')) {
                sectionsData[sectionIndex].questions.splice(qIndex, 1);
                renderSections();
                saveData();
                showToast('سوال حذف شد!');
            }
        }

        function moveQuestion(btn, direction, sectionIndex, qIndex) {
            const questions = sectionsData[sectionIndex].questions;
            if (direction === 'up' && qIndex > 0) {
                [questions[qIndex], questions[qIndex - 1]] = [questions[qIndex - 1], questions[qIndex]];
            } else if (direction === 'down' && qIndex < questions.length - 1) {
                [questions[qIndex], questions[qIndex + 1]] = [questions[qIndex + 1], questions[qIndex]];
            }
            renderSections();
            saveData();
            showToast('سوال جابه‌جا شد!');
        }

        function updatePriority(select, sectionIndex, qIndex) {
            sectionsData[sectionIndex].questions[qIndex].priority = select.value;
            saveData();
            showToast('اولویت به‌روز شد!');
        }

        function setupDragAndDrop() {
            document.querySelectorAll('.draggable').forEach(item => {
                item.addEventListener('dragstart', e => {
                    e.dataTransfer.setData('text/plain', JSON.stringify({
                        sectionIndex: Array.from(document.querySelectorAll('section')).indexOf(e.target.closest('section')),
                        qIndex: parseInt(e.target.dataset.index)
                    }));
                    item.classList.add('dragging');
                });
                item.addEventListener('dragend', e => item.classList.remove('dragging'));
                item.addEventListener('dragover', e => e.preventDefault());
                item.addEventListener('drop', e => {
                    e.preventDefault();
                    const { sectionIndex: sourceSection, qIndex: sourceIndex } = JSON.parse(e.dataTransfer.getData('text/plain'));
                    const targetSection = Array.from(document.querySelectorAll('section')).indexOf(e.target.closest('section'));
                    const targetIndex = parseInt(e.target.closest('li').dataset.index);
                    if (sourceSection === targetSection) {
                        const questions = sectionsData[sourceSection].questions;
                        const temp = questions[sourceIndex];
                        questions.splice(sourceIndex, 1);
                        questions.splice(targetIndex, 0, temp);
                        renderSections();
                        saveData();
                        showToast('سوال جابه‌جا شد!');
                    }
                });
            });
        }

        function setupSectionDragAndDrop() {
            const sections = document.querySelectorAll('.section-draggable');
            sections.forEach(section => {
                section.addEventListener('dragstart', e => {
                    e.dataTransfer.setData('text/plain', section.dataset.index);
                    section.classList.add('dragging');
                });
                section.addEventListener('dragend', e => section.classList.remove('dragging'));
                section.addEventListener('dragover', e => e.preventDefault());
                section.addEventListener('drop', e => {
                    e.preventDefault();
                    const sourceIndex = parseInt(e.dataTransfer.getData('text/plain'));
                    const targetIndex = parseInt(e.target.closest('.section-draggable').dataset.index);
                    if (sourceIndex !== targetIndex) {
                        const [movedSection] = sectionsData.splice(sourceIndex, 1);
                        sectionsData.splice(targetIndex, 0, movedSection);
                        renderSections();
                        saveData();
                        showToast('بخش جابه‌جا شد!');
                    }
                });
            });
        }

        function filterQuestions() {
            const priority = document.getElementById('priorityFilter').value;
            const category = document.getElementById('categoryFilter').value;
            document.querySelectorAll('li').forEach(q => {
                const priorityValue = q.querySelector('.priority').value;
                const categoryValue = q.closest('section').getAttribute('data-category');
                const showPriority = priority === 'all' || priorityValue === priority;
                const showCategory = category === 'all' || categoryValue === category;
                q.style.display = showPriority && showCategory ? '' : 'none';
            });
            document.querySelectorAll('.question-card').forEach(q => {
                const priorityValue = sectionsData[Array.from(document.querySelectorAll('section')).indexOf(q.closest('section'))].questions[parseInt(q.dataset.index)].priority;
                const categoryValue = q.closest('section').getAttribute('data-category');
                const showPriority = priority === 'all' || priorityValue === priority;
                const showCategory = category === 'all' || categoryValue === category;
                q.style.display = showPriority && showCategory ? '' : 'none';
            });
        }

        function searchQuestions() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase().trim();
            if (!searchTerm) {
                renderSections();
                return;
            }
            document.querySelectorAll('li, .question-card').forEach(q => {
                const text = q.querySelector('label')?.textContent.toLowerCase() || q.querySelector('label')?.textContent.toLowerCase();
                const note = sectionsData[Array.from(document.querySelectorAll('section')).indexOf(q.closest('section'))].questions[parseInt(q.dataset.index)].note.toLowerCase();
                const shortAnswer = q.querySelectorAll('textarea')[0]?.value.toLowerCase() || '';
                const keyPoints = q.querySelectorAll('textarea')[1]?.value.toLowerCase() || '';
                const action = q.querySelectorAll('textarea')[2]?.value.toLowerCase() || '';
                if (text.includes(searchTerm) || note.includes(searchTerm) || shortAnswer.includes(searchTerm) || keyPoints.includes(searchTerm) || action.includes(searchTerm)) {
                    q.style.display = '';
                } else {
                    q.style.display = 'none';
                }
            });
        }

        function saveResponses(autoSave = false) {
            const textareas = document.querySelectorAll('textarea');
            if (!autoSave && [...textareas].some(ta => !ta.value.trim())) {
                if (!confirm('برخی فیلدها خالی هستند. ادامه می‌دهید؟')) return;
            }
            const responses = {};
            textareas.forEach((ta, i) => {
                if (ta.classList.contains('section-note')) {
                    responses[`section_note_${ta.dataset.section}`] = ta.value;
                } else {
                    const card = ta.closest('.question-card');
                    if (card) {
                        const sectionIndex = Array.from(document.querySelectorAll('section')).indexOf(card.closest('section'));
                        const qIndex = parseInt(card.dataset.index);
                        const field = ['shortAnswer', 'keyPoints', 'action'][Array.from(card.querySelectorAll('textarea')).indexOf(ta)];
                        responses[`${sectionIndex}_${qIndex}_${field}`] = ta.value;
                    }
                }
            });
            localStorage.setItem('seritaResponses', JSON.stringify(responses));
            if (!autoSave) {
                showToast('پاسخ‌ها ذخیره شدند!');
            }
        }

        function loadResponses() {
            const savedResponses = JSON.parse(localStorage.getItem('seritaResponses') || '{}');
            const savedSections = JSON.parse(localStorage.getItem('seritaSections') || '{}');
            document.querySelectorAll('textarea').forEach((ta, i) => {
                if (ta.classList.contains('section-note')) {
                    if (savedResponses[`section_note_${ta.dataset.section}`]) {
                        ta.value = savedResponses[`section_note_${ta.dataset.section}`];
                    }
                } else {
                    const card = ta.closest('.question-card');
                    if (card) {
                        const sectionIndex = Array.from(document.querySelectorAll('section')).indexOf(card.closest('section'));
                        const qIndex = parseInt(card.dataset.index);
                        const field = ['shortAnswer', 'keyPoints', 'action'][Array.from(card.querySelectorAll('textarea')).indexOf(ta)];
                        if (savedResponses[`${sectionIndex}_${qIndex}_${field}`]) {
                            ta.value = savedResponses[`${sectionIndex}_${qIndex}_${field}`];
                        }
                    }
                }
            });
            if (savedSections && Object.keys(savedSections).length > 0) {
                sectionsData.forEach((section, sectionIndex) => {
                    section.questions.forEach((q, qIndex) => {
                        if (savedSections[sectionIndex] && savedSections[sectionIndex].questions[qIndex]) {
                            q.note = savedSections[sectionIndex].questions[qIndex].note || '';
                        }
                    });
                });
            }
        }

        function exportToCSV() {
            let csv = '\uFEFFبخش,سوال,پاسخ کوتاه,نکات کلیدی,اقدام پیشنهادی,یادداشت\n';
            sectionsData.forEach((section, sectionIndex) => {
                section.questions.forEach((q, qIndex) => {
                    const card = document.querySelectorAll('section')[sectionIndex].querySelectorAll('.question-card')[qIndex];
                    const shortAnswer = card?.querySelectorAll('textarea')[0]?.value.replace(/,/g, ';') || '';
                    const keyPoints = card?.querySelectorAll('textarea')[1]?.value.replace(/,/g, ';') || '';
                    const action = card?.querySelectorAll('textarea')[2]?.value.replace(/,/g, ';') || '';
                    csv += `"${section.title}","${q.text}","${shortAnswer}","${keyPoints}","${action}","${q.note.replace(/,/g, ';')}"\n`;
                });
            });
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'serita_responses.csv';
            a.click();
            URL.revokeObjectURL(url);
            showToast('فایل CSV دانلود شد!');
        }

        function openNoteModal(text, sectionIndex, qIndex) {
            document.getElementById('modalText').value = text || '';
            currentNoteIndex = { sectionIndex, qIndex };
            document.getElementById('noteModal').style.display = 'flex';
        }

        function saveNote() {
            if (currentNoteIndex) {
                const { sectionIndex, qIndex } = currentNoteIndex;
                sectionsData[sectionIndex].questions[qIndex].note = document.getElementById('modalText').value;
                saveData();
                renderSections();
                showToast('یادداشت ذخیره شد!');
            }
            closeNoteModal();
        }

        function closeNoteModal() {
            document.getElementById('noteModal').style.display = 'none';
            currentNoteIndex = null;
        }

        function previewQuestion(btn, sectionIndex, qIndex) {
            currentPreviewRow = btn.closest('.question-card');
            if (currentPreviewRow) {
                const answers = Array.from(currentPreviewRow.querySelectorAll('textarea')).map(ta => ta.value || '').join('\n');
                document.getElementById('previewText').value = answers;
                document.getElementById('previewModal').style.display = 'flex';
            } else {
                showToast('خطا در بارگذاری پیش‌نمایش!');
            }
        }

        function editPreview() {
            if (currentPreviewRow) {
                const textareas = currentPreviewRow.querySelectorAll('textarea');
                const previewText = document.getElementById('previewText').value.split('\n');
                textareas.forEach((ta, i) => ta.value = previewText[i] || '');
                saveResponses();
                closePreviewModal();
                showToast('پاسخ‌ها ویرایش و ذخیره شدند!');
            }
        }

        function closePreviewModal() {
            document.getElementById('previewModal').style.display = 'none';
            currentPreviewRow = null;
        }

        function saveData() {
            try {
                localStorage.setItem('seritaSections', JSON.stringify(sectionsData));
            } catch (e) {
                showToast('خطا در ذخیره داده‌ها!');
                console.error(e);
            }
        }

        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.style.display = 'block';
            setTimeout(() => toast.style.display = 'none', 3000);
        }

        function setupAutoSave() {
            if (autoSaveTimeout) clearTimeout(autoSaveTimeout);
            autoSaveTimeout = setTimeout(() => {
                saveResponses(true);
                saveData();
                const now = new Date().toLocaleTimeString('fa-IR');
                document.getElementById('autoSaveStatus').textContent = `آخرین ذخیره خودکار: ${now}`;
                setupAutoSave();
            }, 10000);
        }

        window.onload = () => {
            const savedSections = localStorage.getItem('seritaSections');
            if (savedSections) sectionsData = JSON.parse(savedSections);
            renderSections();
            loadResponses();
            setupAutoSave();
        };
    </script>
</body>
</html>
